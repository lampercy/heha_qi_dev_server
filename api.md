# Heha_qi backend API draft

## Index

* Get Current User
* Find Users
* Get Friends
* Add Friend
* Invite Friend
* Get Invited Friends
* Create Chat
* Get Chats
* Get Chat
* Update Chat
* Update Last Message
* Add Participants
* Remove Participants
* Join Chat
* Create Battle

## Get Current User

**Description:** Get details of the current user

**Route:** /users/me

**Method:** GET

**Response:**

```
{
  "me": {
    "id": 1234,
    "name": "Percy BB",
    "avatar_url": "http://example.com/avatars/1/thumb.jpg",
    "jid": "ee7ff143a2a549cb95cb24f758c55919@example.com",
    "jpw": "c2932c58a1fc448dac5e86631f5364e5" // server-generated jid and password
  },
}
```


## Find Users

**Description:** Find users by phone numbers, weibo ids, weixin ids or qq ids

**Route:** /users

**Method:** GET

| Param  | Type                | Description  |
| ------ | ------------------- | ------------ |
| phone_numbers| <code>Array</code> | optional |
| weibo_ids | <code>Array</code> | optional |
| weixin_ids | <code>Array</code> | optional |
| qq_ids | <code>Array</code> | optional|

**Response:**

```
{
  "users": [
    {
      "id": 1234,
      "name": "Percy BB",
      "avatar_url": "http://example.com/avatars/1/thumb.jpg",
      "jid": "ee7ff143a2a549cb95cb24f758c55919@example.com"
    },
    ...
  ]
}
```

## Get Friends

**Description:** Get friends of the current user

**Route:** /friends

**Method:** GET

**Response:**

```
{
  "friends": [
    {
      "id": 1234,
      "name": "Percy BB",
      "avatar_url": "http://example.com/avatars/1/thumb.jpg",
      "jid": "ee7ff143a2a549cb95cb24f758c55919@example.com"
    },
    ...
  ]
}
```

## Add Friend

**Description:** Add user as a friend of the current user

**Route:** /friends

**Method:** POST

| Param  | Type                | Description  |
| ------ | ------------------- | ------------ |
| user_id| <code>id</code> | |

**Response:**

* success
```
{
  "success": true
  "user": {
    "id": 1234,
    "name": "Percy BB",
    "avatar_url": "http://example.com/avatars/1/thumb.jpg",
    "jid": "ee7ff143a2a549cb95cb24f758c55919@example.com",
  }
}
```

* fail
```
  {
    "success": false
  }
```

## Invite Friend

**Description:** Invite a friend to join heha

**Route:** /invites

**Method:** POST

| Param  | Type                | Description  |
| ------ | ------------------- | ------------ |
| phone_number| <code>String</code> | optional |
| weibo_id | <code>String</code> | optional |
| weixin_id | <code>String</code> | optional |
| qq_id | <code>String</code> | optional|

**Response:**

* success
```
{
  "success": true
}
```

* fail
```
{
  "success": false
}
```

## Get Invited Friends

**Description:** Get all invites sent by current user

**Route:** /invites

**Method:** GET

**Response:**

```
{
  "invites": [
    {
      "id": 1234,
      "phone_number": 81777778
    },
    {
      "id": 1235,
      "weibo_id": 12345678
    },
    ...
  ]
}
```

## Create Chat

**Description:** Create a chat (either direct message or group chat)

**Route:** /chats

**Method:** POST

| Param  | Type                | Description  |
| ------ | ------------------- | ------------ |
| participant_ids | <code>Array</code> | |
| is_direct_message | <code>Bool</code> | |
| name | <code>String</code> | only for group chat|
| photo| <code>Base64</code> | only for group chat|


**Response:**

* success
```
{
  "success": true
  "chat": {
    "id": 123,
    "is_direct_message": false,
    "name": "My Chat Group",
    "participants": [
      {
        "id": 1234,
        "name": "Percy BB",
        "avatar_url": "http://example.com/avatars/1/thumb.jpg",
        "jid": "ee7ff143a2a549cb95cb24f758c55919@example.com"
      },
      ...
    ],
    "jid": "65ec9a385ee540c892527bca5ca3f936@example.com", // uuid generated by server
    "photo_url": "http://example.com/photos/1/thumb.jpg",
    "battles": [],
    "is_having_battle": false
    "invite_key": '58f271380b86489ba147ed048939ff24' // server-generated invite key
  }
}
```

* fail
```
{
  "success": false
}
```

## Get Chats

**Description:** Get the chats in which the current user is participating

**Route:** /chats

**Method:** GET

**Response:**

```
{
  "chats": [
    {
      "id": 1234,
      "is_direct_message": false,
      "name": "My Chat Group",
      "number_of_participants": 4
      "jid": "my_chat_group-65ec9a385ee540c892527bca5ca3f936@example.com",
      "photo_url": "http://example.com/photos/1/thumb.jpg",
      "last_message": "How are you?",
      "last_message_sent_by": {
        "id": 1234,
        "name": "Percy BB",
        "avatar_url": "http://example.com/avatars/1/thumb.jpg",
        "jid": "ee7ff143a2a549cb95cb24f758c55919@example.com"
      }
      "last_message_sent_at": 12569537329,
      "is_having_battle": true,
      "invite_key": '58f271380b86489ba147ed048939ff24'
    }, 
    ...
  ]
}
```
**Note:** sorted in descending order of last_message_sent_at


## Get Chat

**Description:** Get the details of a chat

**Route:** /chats/:id

**Method:** GET

**Response:**
```
{
  "chat": {
    "id": 1234,
    "is_direct_message": false,
    "name": "My Chat Group",
    "participants": [
      {
        "id": 1234,
        "name": "Percy BB",
        "avatar_url": "http://example.com/avatars/1/thumb.jpg",
        "jid": "ee7ff143a2a549cb95cb24f758c55919@example.com"
      },
      ...
    ],
    "jid": "my_chat_group-65ec9a385ee540c892527bca5ca3f936@example.com",
    "photo_url": "http://example.com/photos/1/thumb.jpg",
    "is_having_battle": true,
    "invite_key": '58f271380b86489ba147ed048939ff24',
    "battles": [
      {
        "id": 1234,
        "chat_id": 1234,
        "steps": {
          "1234": 8000,
          "2234": 3000,
          "3244": 4000
        },
        "current": true,
        "started_at": 12569537329,
        "ended_at": 12569637329
      },
      ...
    ]
  }
}
```

## Update Chat

**Description:** Update the details of a chat (only for group chat)

**Route:** /chats/:id

**Method:** PUT

| Param  | Type                | Description  |
| ------ | ------------------- | ------------ |
| name | <code>String</code> | |
| photo| <code>Base64</code> | |

**Response:**

* success
```
{
  "success": true,
  "chat": {
    "id": 1234,
    "is_direct_message": false,
    "name": "My Chat Group",
    "participants": [
      {
        "id": 1234,
        "name": "Percy BB",
        "avatar_url": "http://example.com/avatars/1/thumb.jpg",
        "jid": "ee7ff143a2a549cb95cb24f758c55919@example.com"
      },
      ...
    ],
    "jid": "my_chat_group-65ec9a385ee540c892527bca5ca3f936@example.com",
    "photo_url": "http://example.com/photos/1/thumb.jpg",
    "is_having_battle": true,
    "invite_key": '58f271380b86489ba147ed048939ff24',
    "battles": [
      {
        "id": 1234,
        "chat_id": 1234,
        "current": true,
        "started_at": 12569537329,
        "ended_at": 12569637329,
        "steps": {
          "1234": 8000,
          "2234": 3000,
          "3244": 4000
        },
      },
      ...
    ]
  }
}
```

* fail
```
{
  "success": false
}
```

## Update Last Message

**Description:** Update the last message of a chat

**Route:** /chats/:id/last_message

**Method:** PUT

| Param  | Type                | Description  |
| ------ | ------------------- | ------------ |
| body | <code>String</code> | message body|

**Response:**

* success 
```
{
  "success": true
}
```

* fail
```
{
  "success": false
}
```

## Add Participants

**Description:** Add participants to a chat

**Route:** /chats/:id/participants

**Method:** POST

| Param  | Type                | Description  |
| ------ | ------------------- | ------------ |
| participant_ids | <code>Array</code> | |

**Response:**

* success 
```
{
  "success": true
  "chat": {
    "id": 1234,
    "is_direct_message": false,
    "name": "My Chat Group",
    "participants": [
      {
        "id": 1234,
        "name": "Percy BB",
        "avatar_url": "http://example.com/avatars/1/thumb.jpg",
        "jid": "ee7ff143a2a549cb95cb24f758c55919@example.com"
      },
      ...
    ],
    "jid": "my_chat_group-65ec9a385ee540c892527bca5ca3f936@example.com",
    "photo_url": "http://example.com/photos/1/thumb.jpg",
    "is_having_battle": true,
    "invite_key": '58f271380b86489ba147ed048939ff24',
    "battles": [
      {
        "id": 1234,
        "chat_id": 1234,
        "current": true,
        "started_at": 12569537329,
        "ended_at": 12569637329,
        "steps": {
          "1234": 8000,
          "2234": 3000,
          "3244": 4000
        },
      },
      ...
    ]
  }
}
```

* fail
```
{
  "success": false
}
```

## Remove Participants

**Description:** Remove participants from a chat

**Route:** /chats/:id/participants

**Method:** DELETE

| Param  | Type                | Description  |
| ------ | ------------------- | ------------ |
| participant_ids | <code>Array</code> | |

**Response:**

* success 
```
{
  "success": true
  "chat": {
    "id": 1234,
    "is_direct_message": false,
    "name": "My Chat Group",
    "participants": [
      {
        "id": 1234,
        "name": "Percy BB",
        "avatar_url": "http://example.com/avatars/1/thumb.jpg",
        "jid": "ee7ff143a2a549cb95cb24f758c55919@example.com"
      },
      ...
    ],
    "jid": "my_chat_group-65ec9a385ee540c892527bca5ca3f936@example.com",
    "photo_url": "http://example.com/photos/1/thumb.jpg",
    "is_having_battle": true,
    "invite_key": '58f271380b86489ba147ed048939ff24',
    "battles": [
      {
        "id": 1234,
        "chat_id": 1234,
        "current": true,
        "started_at": 12569537329,
        "ended_at": 12569637329,
        "steps": {
          "1234": 8000,
          "2234": 3000,
          "3244": 4000
        },
      },
      ...
    ]
  }
}
```

* fail
```
{
  "success": false
}
```

## Join Chat

**Description:** Join a chat by invite key (only for group chat)

**Route:** /chats/:id/join

**Method:** GET

| Param  | Type                | Description  |
| ------ | ------------------- | ------------ |
| invite_key | <code>String</code> | |

**Response:**

* success 
```
{
  "success": true
  "chat": {
    "id": 1234,
    "is_direct_message": false,
    "name": "My Chat Group",
    "participants": [
      {
        "id": 1234,
        "name": "Percy BB",
        "avatar_url": "http://example.com/avatars/1/thumb.jpg",
        "jid": "ee7ff143a2a549cb95cb24f758c55919@example.com"
      },
      ...
    ],
    "jid": "my_chat_group-65ec9a385ee540c892527bca5ca3f936@example.com",
    "photo_url": "http://example.com/photos/1/thumb.jpg",
    "is_having_battle": true,
    "invite_key": '58f271380b86489ba147ed048939ff24',
    "battles": [
      {
        "id": 1234,
        "chat_id": 1234,
        "current": true,
        "started_at": 12569537329,
        "ended_at": 12569637329,
        "steps": {
          "1234": 8000,
          "2234": 3000,
          "3244": 4000
        },
      },
      ...
    ]
  }
}
```

* fail
```
{
  "success": false
}
```

## Create Battle

**Description:** Create a battle

**Route:** /battles

**Method:** POST

| Param  | Type                | Description  |
| ------ | ------------------- | ------------ |
| chat_id| <code>id</code> | |
| started_at | <code>int</code> | timestamp|
| ended_at| <code>int</code> | timestamp|

**Response:**
* success
```
{
  "success": true,
  "battle": {
    "id": 1234,
    "chat_id": 1234,
    "current": true,
    "started_at": 12569537329,
    "ended_at": 12569637329,
    "steps": {
      "1234": 8000,
      "2234": 3000,
      "3244": 4000
    }
  }
}
```

* fail
```
{
  "success": false
}
```
